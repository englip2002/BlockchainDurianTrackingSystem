<!DOCTYPE html>
<html>
    <head>
        <title>Worker</title>
        <script
            type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
        <script
            src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"
            type="text/javascript"></script>

        <!-- Bootstrap 5 -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
            crossorigin="anonymous" />
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>

        <!-- Sweet Alert 2 -->
        <script src="
        https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js
        "></script>
        <link
            href="
        https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css
        "
            rel="stylesheet" />

        <link rel="stylesheet" href="./style.css" />
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">Durian Track and Trace Blockchain Application</a>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link" href="/">Admin</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="/worker.html"
                                >Worker</a
                            >
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/customer.html">Customer</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/traceDurian.html">Trace Durian</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container">
            <br />
            <div class="row">
                <div class="btn-group" role="group" aria-label="Basic example">
                    <button type="button" class="btn btn-primary" onclick="switchUI('farm')">
                        Durian Farm Worker
                    </button>
                    <button
                        type="button"
                        class="btn btn-primary"
                        onclick="switchUI('distribution')">
                        Distribution Center Worker
                    </button>
                    <button type="button" class="btn btn-primary" onclick="switchUI('retail')">
                        Retailer Worker
                    </button>
                </div>
            </div>
            <br />
            <!-- farmWorkerUI -->
            <div id="farmWorkerUI">
                <div class="container">
                    <div class="row">
                        <h1 style="text-align: center">Harvest Durian</h1>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="mb-3">
                                <label for="weightInGrams" class="form-label"
                                    >Durian weight (grams)</label
                                >
                                <input
                                    type="number"
                                    class="form-control"
                                    id="weightInGrams"
                                    placeholder="1500..." />
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col">
                            <div class="mb-3">
                                <label for="durianFarmSelect" class="form-label"
                                    >Belongs to durian farm:
                                </label>
                                <select
                                    class="form-select"
                                    aria-label="Durian Farm"
                                    id="durianFarmSelect"
                                    onchange="updateDurianTreeSelections()"></select>
                            </div>
                        </div>
                        <div class="col">
                            <div class="mb-3">
                                <label for="durianTreeSelect" class="form-label"
                                    >Belongs to durian tree:
                                </label>
                                <select
                                    class="form-select"
                                    aria-label="Durian Tree"
                                    id="durianTreeSelect"></select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <button type="button" class="btn btn-primary" onclick="submitAddDurian()">
                            Mark Harvested
                        </button>
                        <br />
                    </div>
                </div>
            </div>
            <!-- distributionWorkerUI -->

            <div id="distributionWorkerUI" style="display: none">
                <div class="container">
                    <form novalidate class="row g-3 needs-validation">
                        <div class="row">
                            <br />
                            <h1 style="text-align: center">
                                Record Durian for Distribution Centers
                            </h1>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="mb-3">
                                    <label for="durianIDinput" class="form-label"
                                        >Enter Durian ID:
                                    </label>
                                    <input
                                        required
                                        type="text"
                                        class="form-control"
                                        id="durianIDinput"
                                        placeholder="D001..." />
                                    <div class="invalid-feedback">
                                        Please enter a valid Durian ID.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <button
                                type="button"
                                class="btn btn-primary"
                                onclick="submitRecordDC()">
                                Mark as Recorded at Distribution Center
                            </button>
                            <br />
                        </div>
                    </form>
                </div>
            </div>

            <!-- retailerWorkerUI -->
            <div id="retailerWorkerUI" style="display: none">
                <div class="container">
                    <form novalidate class="row g-3 needs-validation">
                        <div class="row">
                            <h1 style="text-align: center">Record Durian for Retailers</h1>
                        </div>
                        <div class="row">
                            <div class="col">
                                <div class="mb-3">
                                    <label for="durianIDinputRetail" class="form-label"
                                        >Enter Durian ID:
                                    </label>
                                    <input
                                        required
                                        type="text"
                                        class="form-control"
                                        id="durianIDinputRetail"
                                        placeholder="D001..." />
                                    <div class="invalid-feedback">
                                        Please enter a valid Durian ID.
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="durianSellPriceRetailer" class="form-label"
                                        >Enter Durian Sell Price (RM):
                                    </label>
                                    <input
                                        required
                                        type="number"
                                        class="form-control"
                                        id="durianSellPriceRetailer"
                                        placeholder="42.00" />
                                    <div class="invalid-feedback">
                                        Please enter a valid Durian sell price.
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <button
                                type="button"
                                class="btn btn-primary"
                                onclick="submitRecordRetailer()">
                                Mark as Recorded at Retailer
                            </button>
                            <br />
                        </div>
                    </form>
                </div>
            </div>

            <br /><br />
            <div class="row">
                <h2>Durians</h2>
            </div>
            <div class="row">
                <table class="table">
                    <thead>
                        <tr>
                            <th scope="col">Durian ID</th>
                            <th scope="col">Current Stage</th>
                            <th scope="col">Grade</th>
                            <th scope="col">Weight (grams)</th>
                            <th scope="col">Durian Farm</th>
                            <th scope="col">Durian Tree</th>
                            <th scope="col">Selling Price (RM)</th>
                            <th scope="col">Bought by Customer</th>
                        </tr>
                    </thead>
                    <tbody id="duriansTableBody"></tbody>
                </table>
            </div>
        </div>

        <script>
            //1- connect metamask
            let account;

            const accessToMetamask = async () => {
                if (window.ethereum !== "undefined") {
                    const accounts = await ethereum.request({
                        method: "eth_requestAccounts",
                    });
                    account = accounts[0];
                    // document.getElementById("accountArea").innerHTML = account;
                }
            };

            //2- connect to smart contract
            const accessToContract = async () => {
                var ABI = [];

                await $.getJSON("./abi.json", (data) => {
                    ABI = data;
                });

                var Address = "";

                await $.getJSON("./address.json", (addr) => {
                    Address = addr;
                });

                window.web3 = await new Web3(window.ethereum); //how to access to smart contract
                window.contract = await new window.web3.eth.Contract(ABI, Address); //how you create an instance of that contract by using the abi and address
            };

            const switchUI = (target) => {
                farmUI = document.getElementById("farmWorkerUI");
                distUI = document.getElementById("distributionWorkerUI");
                retaUI = document.getElementById("retailerWorkerUI");
                switch (target) {
                    case "farm":
                        farmUI.style.display = "block";
                        distUI.style.display = "none";
                        retaUI.style.display = "none";
                        break;
                    case "distribution":
                        farmUI.style.display = "none";
                        distUI.style.display = "block";
                        retaUI.style.display = "none";
                        break;
                    case "retail":
                        farmUI.style.display = "none";
                        distUI.style.display = "none";
                        retaUI.style.display = "block";
                        break;
                    default:
                        break;
                }
            };

            const parseIntToID = (i, type) => {
                let check = "";
                if (type == "farm") check = "F";
                else if (type == "tree") check = "T";
                else if (type == "durian") check = "D";
                else if (type == "worker") check = "W";
                else {
                    console.log("Invalid type to parse. ");
                    return false;
                }

                let x = i.toString();
                while (x.length < 3) {
                    x = "0" + x;
                }
                result = check + x;
                return result;
            };

            const updateDurianFarmSelections = () => {
                durianFarmEl = document.getElementById("durianFarmSelect");
                durianFarmEl.innerHTML = "";
                let first = true;
                window.contract.methods
                    .durianFarmCount()
                    .call()
                    .then((farmCount) => {
                        for (let n = 1; n <= farmCount; n++) {
                            window.contract.methods
                                .durianFarms(parseIntToID(n, "farm"))
                                .call()
                                .then((farm) => {
                                    if (farm.exist) {
                                        thisId = parseIntToID(n, "farm");

                                        finalStr = "<option ";
                                        if (first) {
                                            first = false;
                                            finalStr += "selected ";
                                        }
                                        finalStr +=
                                            `value="` +
                                            thisId +
                                            `">` +
                                            thisId +
                                            ` : ` +
                                            farm.name +
                                            `</option>
                                        `;
                                        durianFarmEl.innerHTML += finalStr;
                                    }
                                });
                        }
                    });
            };

            const updateDurianTreeSelections = () => {
                durianTreeEl = document.getElementById("durianTreeSelect");
                selectedFarmID = document.getElementById("durianFarmSelect").value;
                durianTreeEl.innerHTML = "";

                if (selectedFarmID.length == 0) {
                    return;
                }

                window.contract.methods
                    .durianTreesCount()
                    .call()
                    .then((treeCount) => {
                        for (let n = 1; n <= treeCount; n++) {
                            window.contract.methods
                                .durianTrees(parseIntToID(n, "tree"))
                                .call()
                                .then((tree) => {
                                    if (tree.exist && tree.durianFarmID == selectedFarmID) {
                                        treeID = parseIntToID(n, "tree");
                                        durianTreeEl.innerHTML +=
                                            `<option value="` +
                                            treeID +
                                            `">` +
                                            treeID +
                                            `</option>`;
                                    }
                                });
                        }
                    });
            };

            const verifyAddDurian = (inputWeight, inputFarm, inputTree) => {
                result = inputWeight > 0 && inputFarm.length != 0 && inputTree.length != 0;
                if (!result) {
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: "All fields are required!",
                    });
                }
                return result;
            };

            const submitAddDurian = () => {
                inputWeight = document.getElementById("weightInGrams").value;
                inputFarm = document.getElementById("durianFarmSelect").value;
                inputTree = document.getElementById("durianTreeSelect").value;

                if (!verifyAddDurian(inputWeight, inputFarm, inputTree)) {
                    return;
                }

                window.contract.methods
                    .durianCount()
                    .call()
                    .then((durianCount) => {
                        durianID = parseIntToID(parseInt(durianCount) + 1, "durian");
                        console.log(durianID, inputWeight, inputFarm, inputTree);
                        return window.contract.methods
                            .addDurian(durianID, parseInt(inputWeight), inputFarm, inputTree)
                            .send({ from: account });
                    })
                    .then((result) => {
                        return getAllDurians();
                    })
                    .then((result) => {
                        Swal.fire({
                            icon: "success",
                            title: "Success!",
                            text: "The durian is added to the blockchain!",
                        });
                    })
                    .catch((err) => {
                        Swal.fire({
                            icon: "error",
                            title: "Oops...",
                            text: "Something went wrong! Please check if your values are correct and valid. ",
                        });
                        console.log(err);
                    });
            };
        </script>
        <script>
            const parseDurianPrice = (price) => {
                return Math.floor(price / 100).toString() + "." + (price % 100).toString();
            }

            const getDurianStage = async (stage) => {
                let result = "-";
                await $.getJSON("json/durianStage.json", (data) => {
                    for (let i = 0; i < data.length; i++) {
                        if (data[i].id == stage) {
                            result = data[i].name;
                            break;
                        }
                    }
                });
                return result;
            };

            const getDurianGrade = async (grade) => {
                let result = "-";
                await $.getJSON("json/grade.json", (data) => {
                    for (let i = 0; i < data.length; i++) {
                        if (data[i].id == grade) {
                            result = data[i].name;
                            break;
                        }
                    }
                });
                return result;
            };

            const getAllDurians = () => {
                let tableBody = document.getElementById("duriansTableBody");
                tableBody.innerHTML = "";
                window.contract.methods
                    .durianCount()
                    .call()
                    .then((durianCount) => {
                        for (let i = 1; i <= durianCount; i++) {
                            let durianID = parseIntToID(i, "durian");
                            window.contract.methods
                                .durians(durianID)
                                .call()
                                .then((durian) => {
                                    console.log(durian);
                                    if (durian.exist) {
                                        getDurianStage(durian.supplyChainStage).then(
                                            (durianStage) => {
                                                getDurianGrade(durian.grade).then((durianGrade) => {
                                                    window.contract.methods
                                                        .durianFarms(durian.durianFarmID)
                                                        .call()
                                                        .then((farm) => {
                                                            let priceStr = durianStage == "At Retailer" ? parseDurianPrice(durian.sellPrice) : "-";
                                                            let bbc = durian.boughtByCustomer;
                                                            if (
                                                                durian.boughtByCustomer ==
                                                                "0x0000000000000000000000000000000000000000"
                                                            ) {
                                                                bbc = "-";
                                                            }
                                                            // prettier-ignore
                                                            tableBody.innerHTML += `
                                                            <tr>
                                                                <th scope="row">` + durianID + `</th>
                                                                <td>` + durianStage + `</td>
                                                                <td>` + durianGrade + `</td>
                                                                <td>` + durian.weightInGrams + `</td>
                                                                <td>` + durian.durianFarmID + " : " + farm.name + `</td>
                                                                <td>` + durian.durianTreeID + `</td>
                                                                <td>` + priceStr + `</td>
                                                                <td>` + bbc + `</td>
                                                            </tr>`;
                                                        });
                                                });
                                            }
                                        );
                                    }
                                });
                        }
                    });
            };
        </script>

        <script>
            const verifyRecordDC = (durianID) => {
                result = durianID.length == 4;
                if (!result) {
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: "Something went wrong! Please check if your values are correct and valid. ",
                    });
                }
                return result;
            };
            const submitRecordDC = () => {
                let durianIDinput = document.getElementById("durianIDinput").value.toUpperCase();
                if (!verifyRecordDC(durianIDinput)) return;

                window.contract.methods
                    .durians(durianIDinput)
                    .call()
                    .then((durian) => {
                        if (durian.exist) {
                            window.contract.methods
                                .recordDurianDistributionCenter(durianIDinput)
                                .send({ from: account })
                                .then((result) => {
                                    getAllDurians();
                                })
                                .catch((err) => {
                                    console.log(err);
                                    Swal.fire({
                                        icon: "error",
                                        title: "Oops...",
                                        text: "Something went wrong in the blockchain transaction! ",
                                    });
                                });
                        } else {
                            Swal.fire({
                                icon: "error",
                                title: "Oops...",
                                text: "This durian ID doesn't exist! ",
                            });
                        }
                    });
            };

            const verifyRecordRetailer = (durianID, durianSellPrice) => {
                result =
                    durianID.length == 4 &&
                    (durianSellPrice.indexOf(".") == -1 ||
                        (durianSellPrice.indexOf(".") != -1 &&
                            durianSellPrice.length - durianSellPrice.indexOf(".") <= 3));
                if (!result) {
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: "Something went wrong! Please check if your values are correct and valid. ",
                    });
                }
                return result;
            };

            const submitRecordRetailer = () => {
                let durianIDinput = document
                    .getElementById("durianIDinputRetail")
                    .value.toUpperCase();
                let durianSellPrice = document.getElementById("durianSellPriceRetailer").value;
                if (!verifyRecordRetailer(durianIDinput, durianSellPrice)) return;

                let durianSellPriceFormatted = parseInt(
                    parseFloat(durianSellPrice).toFixed(2).toString().replace(".", "")
                );

                window.contract.methods
                    .durians(durianIDinput)
                    .call()
                    .then((durian) => {
                        if (durian.exist) {
                            window.contract.methods
                                .recordDurianRetailer(durianIDinput, durianSellPriceFormatted)
                                .send({ from: account })
                                .then((result) => {
                                    getAllDurians();
                                })
                                .catch((err) => {
                                    console.log(err);
                                    Swal.fire({
                                        icon: "error",
                                        title: "Oops...",
                                        text: "Something went wrong in the blockchain transaction! ",
                                    });
                                });
                        } else {
                            Swal.fire({
                                icon: "error",
                                title: "Oops...",
                                text: "This durian ID doesn't exist! ",
                            });
                        }
                    });
            };
        </script>
        <script>
            accessToMetamask();
            accessToContract().then((out) => {
                updateDurianFarmSelections();
                updateDurianTreeSelections();
                getAllDurians();
            });

            window.ethereum.on("accountsChanged", function (accounts) {
                console.log("Metamask account change detected!");
                accessToMetamask();
            });

            setTimeout(() => {
                updateDurianTreeSelections();
            }, 300);
        </script>
    </body>
</html>
