<!DOCTYPE html>
<html>
    <head>
        <title>Admin</title>
        <script
            type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/web3/1.2.7-rc.0/web3.min.js"></script>
        <script
            src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"
            type="text/javascript"></script>

        <!-- Bootstrap 5 -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
            crossorigin="anonymous" />
        <script
            src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
            crossorigin="anonymous"></script>

        <!-- Sweet Alert 2 -->
        <script src="
        https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.all.min.js
        "></script>
        <link
            href="
        https://cdn.jsdelivr.net/npm/sweetalert2@11.7.3/dist/sweetalert2.min.css
        "
            rel="stylesheet" />

        <link rel="stylesheet" href="./style.css" />
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <div class="container-fluid">
                <a class="navbar-brand" href="/">Durian Track and Trace Blockchain Application</a>
                <div class="collapse navbar-collapse" id="navbarSupportedContent">
                    <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                        <li class="nav-item">
                            <a class="nav-link active" aria-current="page" href="/">Admin</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/worker.html">Worker</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/customer.html">Customer</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/traceDurian.html">Trace Durian</a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div class="container">
            <br />
            <div class="row">
                <div class="btn-group" role="group" aria-label="Basic example">
                    <button type="button" class="btn btn-primary" onclick="switchFarmUI()">
                        Add Durian Farm
                    </button>
                    <button type="button" class="btn btn-primary" onclick="switchTreeUI()">
                        Add Durian Tree
                    </button>
                    <button type="button" class="btn btn-primary" onclick="switchWorkerUI()">
                        Add Workers
                    </button>
                </div>
            </div>
            <br />
            <div id="durianFarmUI">
                <div class="row">
                    <h1 style="text-align: center">Add Durian Farm</h1>
                </div>
                <div class="row">
                    <div class="mb-3">
                        <label for="farmName" class="form-label">Farm Name</label>
                        <input
                            type="text"
                            class="form-control"
                            id="farmName"
                            placeholder="Enter farm name..." />
                    </div>
                    <div class="mb-3">
                        <label for="farmLocation" class="form-label">Farm Location</label>
                        <input
                            type="text"
                            class="form-control"
                            id="farmLocation"
                            placeholder="Enter farm location..." />
                    </div>
                    <button type="button" class="btn btn-primary" onclick="submitAddFarm()">
                        Submit
                    </button>
                </div>
                <br /><br />
                <div class="row">
                    <h2>Durian Farms</h2>
                </div>
                <div class="row">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Farm ID</th>
                                <th scope="col">Name</th>
                                <th scope="col">Location</th>
                                <th scope="col">Number Of Durian Trees</th>
                            </tr>
                        </thead>
                        <tbody id="durianFarmTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="durianTreeUI" style="display: none">
                <div class="row">
                    <h1 style="text-align: center">Add Durian Tree</h1>
                </div>
                <div class="row">
                    <div class="mb-3">
                        <label for="treeSpecies" class="form-label">Durian Tree Species</label>
                        <select
                            class="form-select"
                            aria-label="Default select example0"
                            id="durianSpeciesSelect">
                            <option selected disabled="disabled" value="0">
                                Select a durian tree species
                            </option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="treeAge" class="form-label">Age of tree (Years)</label>
                        <input
                            type="number"
                            class="form-control"
                            id="treeAge"
                            placeholder="Enter age of tree..." />
                    </div>
                    <div class="mb-3">
                        <label for="treeSelectFarm" class="form-label">Belong to Durian Farm</label>
                        <select
                            class="form-select"
                            aria-label="Default select example0"
                            id="treeSelectFarm">
                            <option selected disabled="disabled" value="0">
                                Select a durian farm
                            </option>
                        </select>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="submitAddTree()">
                        Submit
                    </button>
                </div>
                <br /><br />
                <div class="row">
                    <h2>Durian Farms</h2>
                </div>
                <div class="row">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Tree ID</th>
                                <th scope="col">Species</th>
                                <th scope="col">Age (Years)</th>
                                <th scope="col">Last Harvest Time</th>
                                <th scope="col">Belong to Durian Farm</th>
                            </tr>
                        </thead>
                        <tbody id="durianTreeTableBody"></tbody>
                    </table>
                </div>
            </div>

            <div id="workerUI" style="display: none">
                <div class="row">
                    <h1 style="text-align: center">Add Worker</h1>
                </div>
                <div class="row">
                    <div class="mb-3">
                        <label for="workerName" class="form-label">Worker Name: </label>
                        <input
                            type="text"
                            class="form-control"
                            id="workerName"
                            placeholder="Enter name of worker..." />
                    </div>
                    <div class="mb-3">
                        <label for="workerAddress" class="form-label"
                            >Worker's Public Address:
                        </label>
                        <input
                            type="text"
                            class="form-control"
                            id="workerAddress"
                            placeholder="Enter the public address of worker..." />
                    </div>
                    <div class="mb-3">
                        <label for="workerWorkFor" class="form-label">Working For: </label>
                        <select
                            class="form-select"
                            aria-label="Worker Work for"
                            id="workerWorkFor"></select>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="submitAddWorker()">
                        Submit
                    </button>
                </div>
                <br /><br />
                <div class="row">
                    <h2>List of Workers</h2>
                </div>
                <div class="row">
                    <table class="table">
                        <thead>
                            <tr>
                                <th scope="col">Worker ID</th>
                                <th scope="col">Name</th>
                                <th scope="col">Public Address</th>
                                <th scope="col">Worked For</th>
                            </tr>
                        </thead>
                        <tbody id="workerListBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <script>
            //1- connect metamask
            let account;

            const accessToMetamask = async () => {
                if (window.ethereum !== "undefined") {
                    const accounts = await ethereum.request({
                        method: "eth_requestAccounts",
                    });
                    account = accounts[0];
                    // document.getElementById("accountArea").innerHTML = account;
                }
            };

            //2- connect to smart contract
            const accessToContract = async () => {
                var ABI = [];

                await $.getJSON("./abi.json", (data) => {
                    ABI = data;
                });

                var Address = "";

                await $.getJSON("./address.json", (addr) => {
                    Address = addr;
                });

                window.web3 = await new Web3(window.ethereum); //how to access to smart contract
                window.contract = await new window.web3.eth.Contract(ABI, Address); //how you create an instance of that contract by using the abi and address
            };

            const switchFarmUI = () => {
                document.getElementById("durianFarmUI").style.display = "block";
                document.getElementById("durianTreeUI").style.display = "none";
                document.getElementById("workerUI").style.display = "none";
            };

            const switchTreeUI = () => {
                document.getElementById("durianFarmUI").style.display = "none";
                document.getElementById("durianTreeUI").style.display = "block";
                document.getElementById("workerUI").style.display = "none";
            };

            const switchWorkerUI = () => {
                document.getElementById("durianFarmUI").style.display = "none";
                document.getElementById("durianTreeUI").style.display = "none";
                document.getElementById("workerUI").style.display = "block";
            };

            const parseIntToID = (i, type) => {
                let check = "";
                if (type == "farm") check = "F";
                else if (type == "tree") check = "T";
                else if (type == "durian") check = "D";
                else if (type == "worker") check = "W";
                else {
                    console.log("Invalid type to parse. ");
                    return false;
                }

                let x = i.toString();
                while (x.length < 3) {
                    x = "0" + x;
                }
                result = check + x;
                return result;
            };

            const submitAddFarm = async () => {
                farmName = document.getElementById("farmName").value;
                farmLocation = document.getElementById("farmLocation").value;

                if (!verifyFarmDetails()) {
                    return;
                }

                // Generate farm ID
                let farmID = "";
                window.contract.methods
                    .durianFarmCount()
                    .call()
                    .then((data) => {
                        farmID = parseIntToID(parseInt(data) + 1, "farm");
                    })
                    .then((result) => {
                        return window.contract.methods
                            .addDurianFarm(farmID, farmName, farmLocation)
                            .send({ from: account });
                    })
                    .then((result) => {
                        return updateDurianFarmSelect();
                    })
                    .then((result) => {
                        return getAllFarms();
                    })
                    .then((result) => {
                        Swal.fire({
                            icon: "success",
                            title: "Success!",
                            text: "The durian farm is added to the blockchain",
                        });
                    })
                    .catch((err) => {
                        console.log(err);
                    });
            };

            const verifyFarmDetails = () => {
                farmName = document.getElementById("farmName").value;
                farmLocation = document.getElementById("farmLocation").value;
                result = farmName.length != 0 && farmLocation.length != 0;
                if (!result) {
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: "All fields are required!",
                    });
                }
                return result;
            };

            const getAllFarms = async () => {
                tableBody = document.getElementById("durianFarmTableBody");
                tableBody.innerHTML = "";
                window.contract.methods
                    .durianFarmCount()
                    .call()
                    .then((data) => {
                        durianFarmCount = data;
                        for (let n = 1; n <= durianFarmCount; n++) {
                            thisId = parseIntToID(n, "farm");
                            window.contract.methods
                                .durianFarms(thisId)
                                .call()
                                .then((farm) => {
                                    if (farm.exist) {
                                        tableBody.innerHTML +=
                                            `<tr>
                                            <th scope="row" class="dfCol1">` +
                                            parseIntToID(n, "farm") +
                                            `</th>
                                            <td class="dfCol2">` +
                                            farm.name +
                                            `</td>
                                            <td class="dfCol3">` +
                                            farm.location +
                                            `</td>
                                            <td class="dfCol4">` +
                                            farm.durianTreeCount +
                                            `</td>
                                        </tr>`;
                                    }
                                });
                        }
                    });
            };

            // const initDurianFarms = async () => {
            //     $.getJSON("json/durianFarmsAndTrees.json", (data) => {
            //         for (let i = 0; i < data.length; i++) {
            //             window.contract.methods.addDurianFarm(
            //                 data[i].id,
            //                 data[i].name,
            //                 data[i].location
            //             );
            //             for (let j = 0; j < data[i].durianTrees.length; j++) {
            //                 let x = data[i].durianTrees[j];
            //                 window.contract.methods.addDurianTreeWithHarvestTime(
            //                     x.id,
            //                     x.age,
            //                     x.species,
            //                     x.lastHarvestTime
            //                 );
            //             }
            //         }
            //     });
            // };
        </script>
        <script>
            const loadDurianSpecies = async () => {
                speciesSelect = document.getElementById("durianSpeciesSelect");
                $.getJSON("json/durianSpecies.json", (data) => {
                    for (let i = 0; i < data.length; i++) {
                        speciesSelect.innerHTML +=
                            `<option value="` + data[i] + `">` + data[i] + `</option>`;
                    }
                });
            };

            const updateDurianFarmSelect = async () => {
                treeSelectFarm = document.getElementById("treeSelectFarm");
                treeSelectFarm.innerHTML = `<option selected disabled="disabled" value="0">Select a durian farm</option>`;
                window.contract.methods
                    .durianFarmCount()
                    .call()
                    .then((durianFarmCount) => {
                        for (let n = 1; n <= durianFarmCount; n++) {
                            window.contract.methods
                                .durianFarms(parseIntToID(n, "farm"))
                                .call()
                                .then((farm) => {
                                    if (farm.exist) {
                                        thisId = parseIntToID(n, "farm");
                                        treeSelectFarm.innerHTML +=
                                            `<option value="` +
                                            thisId +
                                            `">` +
                                            thisId +
                                            " : " +
                                            farm.name +
                                            `</option>`;
                                    }
                                });
                        }
                    });
            };

            const submitAddTree = async () => {
                treeSpecies = document.getElementById("durianSpeciesSelect").value;
                treeAge = document.getElementById("treeAge").value;
                treeFarm = document.getElementById("treeSelectFarm").value;

                if (!verifyDurianTreeInputs()) {
                    return;
                }

                // Generate Tree ID
                let treeID = "";
                window.contract.methods
                    .durianTreesCount()
                    .call()
                    .then((data) => {
                        treeID = parseIntToID(parseInt(data) + 1, "tree");
                    })
                    .then((result) => {
                        return window.contract.methods
                            .addDurianTree(treeID, treeAge, treeSpecies, treeFarm)
                            .send({ from: account });
                    })
                    .then((result) => {
                        getAllTrees();
                    })
                    .then((result) => {
                        Swal.fire({
                            icon: "success",
                            title: "Success!",
                            text: "The durian tree is added to the blockchain!",
                        });
                    })
                    .catch((err) => {
                        console.log(error);
                    });
            };

            const verifyDurianTreeInputs = () => {
                treeSpecies = document.getElementById("durianSpeciesSelect").value;
                treeAge = document.getElementById("treeAge").value;
                treeFarm = document.getElementById("treeSelectFarm").value;
                result = treeSpecies != 0 && treeAge != "" && treeAge >= 0 && treeFarm.length != 0;
                if (!result) {
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: "All fields are required!",
                    });
                }
                return result;
            };

            const getAllTrees = async () => {
                tableBody2 = document.getElementById("durianTreeTableBody");
                tableBody2.innerHTML = "";
                var d = new Date(0);
                window.contract.methods
                    .durianTreesCount()
                    .call()
                    .then((durianTreeCount) => {
                        for (let n = 1; n <= durianTreeCount; n++) {
                            thisId = parseIntToID(n, "tree");
                            window.contract.methods
                                .durianTrees(thisId)
                                .call()
                                .then((tree) => {
                                    if (tree.exist) {
                                        harvestTime = "";
                                        if (tree.lastHarvestTime == 0) {
                                            harvestTime = "-";
                                        } else {
                                            d.setUTCSeconds(parseInt(tree.lastHarvestTime));
                                            harvestTime = d.toDateString();
                                        }
                                        let tempHTML = "";
                                        tempHTML +=
                                            `<tr>
                                                <th scope="row" class="dfCol1">` +
                                            parseIntToID(n, "tree") +
                                            `</th>
                                                <td class="dfCol2">` +
                                            tree.species +
                                            `</td>
                                                <td class="dfCol3">` +
                                            tree.age +
                                            `</td>
                                                <td class="dfCol4">` +
                                            harvestTime +
                                            `</td>
                                                <td class="dfCol5">` +
                                            tree.durianFarmID +
                                            " : ";
                                        window.contract.methods
                                            .durianFarms(tree.durianFarmID)
                                            .call()
                                            .then((farm) => {
                                                tempHTML += farm.name + `</td></tr>`;
                                                tableBody2.innerHTML += tempHTML;
                                                tempHTML = "";
                                            })
                                            .catch((err) => {
                                                console.log(err);
                                            });
                                    }
                                });
                        }
                    });
            };
        </script>
        <script>
            const updateWorkerWorkForSelections = () => {
                workForEl = document.getElementById("workerWorkFor");
                workForEl.innerHTML = "";
                $.getJSON("json/workFor.json", (data) => {
                    for (let i = 1; i < data.length; i++) {
                        workForEl.innerHTML +=
                            `<option value="` + data[i].id + `">` + data[i].name + `</option>`;
                    }
                });
            };

            const verifyAddWorker = (wName, wAddress, wWorkFor) => {
                result = wName.length != 0 && wAddress.length != 0 && wWorkFor > 0;
                if (!result) {
                    Swal.fire({
                        icon: "error",
                        title: "Oops...",
                        text: "All fields are required!",
                    });
                }
                return result;
            };

            const submitAddWorker = () => {
                wName = document.getElementById("workerName").value;
                wAddress = document.getElementById("workerAddress").value;
                wWorkFor = document.getElementById("workerWorkFor").value;

                if (!verifyAddWorker(wName, wAddress, wWorkFor)) {
                    return;
                }

                window.contract.methods
                    .workerCount()
                    .call()
                    .then((workerCount) => {
                        workerID = parseIntToID(workerCount + 1, "worker");
                        console.log(wName, wAddress, wWorkFor);
                        return window.contract.methods
                            .addWorker(wName, wAddress, wWorkFor.toString())
                            .send({ from: account });
                    })
                    .then((result) => {
                        Swal.fire({
                            icon: "success",
                            title: "Success!",
                            text: "The worker is added to the blockchain!",
                        });
                    })
                    .then((res) => {
                        getAllWorkers();
                    })
                    .catch((err) => {
                        Swal.fire({
                            icon: "error",
                            title: "Oops...",
                            text: "Something went wrong. Please check if your values are correct and valid. ",
                        });
                        console.log(err);
                    });
            };

            const getAllWorkers = () => {
                let tableBody = document.getElementById("workerListBody");
                tableBody.innerHTML = "";
                var workForList;
                $.getJSON("json/workFor.json", (data) => {
                    workForList = data;
                });
                window.contract.methods
                    .workerCount()
                    .call()
                    .then((workerCount) => {
                        console.log(workerCount);
                        for (let i = 0; i < workerCount; i++) {
                            window.contract.methods
                                .workerAddresses(i)
                                .call()
                                .then((address) => {
                                    let addr = address;
                                    window.contract.methods
                                        .workerList(address)
                                        .call()
                                        .then((worker) => {
                                            console.log(worker);
                                            wID = parseIntToID(
                                                parseInt(worker.workerID) + 1,
                                                "worker"
                                            );

                                            wWorkFor = "";
                                            for (let j = 0; j < workForList.length; j++) {
                                                if (workForList[j].id == worker.workedFor) {
                                                    wWorkFor = workForList[j].name;
                                                    break;
                                                }
                                            }

                                            tableBody.innerHTML +=
                                                `<tr>
                                            <th scope="row" class="dfCol1">` +
                                                wID +
                                                `</th>
                                            <td class="dfCol2">` +
                                                worker.name +
                                                `</th>
                                            <td class="dfCol3">` +
                                                addr +
                                                `</td>
                                            <td class="dfCol4">` +
                                                wWorkFor +
                                                `</td>`;
                                        });
                                });
                        }
                    });
            };
        </script>
        <script>
            accessToMetamask()
                .then((out) => {
                    return accessToContract();
                })
                .then((out) => {
                    getAllFarms();
                    getAllTrees();
                    getAllWorkers();
                    updateDurianFarmSelect();
                });
            loadDurianSpecies();
            updateWorkerWorkForSelections();

            window.ethereum.on("accountsChanged", function (accounts) {
                console.log("Metamask account change detected!");
                accessToMetamask();
            });
        </script>
    </body>
</html>
